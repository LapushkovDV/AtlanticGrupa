procedure fillrecArray_ResolveDiscrepancy;
{
    var _npp: byte;
        _npp := 1;
    SetLimit(_recArray, 0);
    SetLimit(_recArray, 1);

  _recArray[_npp].def := coPS1_stock_GUID   ; SetLimit(_recArray, GetLimit(_recArray) + 1); _npp++;
  _recArray[_npp].def := co_PS1_REQUESTERROR;

}
Procedure Insert_ResolveDiscrepancy;
{
  var _i: byte;

  clearBuffer(tntDiscrepancy);
  for(_i := 1; _I <= getLimit(_recArray); _i++)
  {
    case upcase(_recArray[_i].def) of
      Upcase(coPS1_stock_GUID )    : tDiscrepancy.Guid  := Trim(_recArray[_i].value);
      Upcase(co_PS1_REQUESTERROR)  : tDiscrepancy.Error := Trim(_recArray[_i].value);
    end;
  }
   Insert Current tDiscrepancy;
}  // tInsertSaldoMC
Procedure FillPS1_VetisAPI_ResolveDiscrepancy(_ExcelFileOut, _OleGenerateGUID: string; _empty : string);
{
  _empty := '';
  MyWriteLN('Get-ChildItem -Path $PSScriptRoot -Include @("*.ps1","*.log", "*.xls*") -Recurse | Where-Object -Property CreationTime -lt (Get-Date).AddDays(-8) | Remove-Item -Force -ErrorAction SilentlyContinue');
  MyWriteLN('$circuitserviceID="'+coCircuit_serviceID+'"                              ');
  MyWriteLN('$circuitendpointUrl="'+coCircuit_endpointUrlResolveDiscrepancy+'"                          ');
  MyWriteLN('$circuitlogin="'+coCircuit_login+'"                                      ');
  MyWriteLN('$circuitpassword="'+coCircuit_password+'"                                ');
  MyWriteLN('$circuitapiKey="'+coCircuit_apiKey+'"                            ');
  MyWriteLN('$circuitissureId="'+coCircuit_issureId+'"                                ');
  MyWriteLN('$circuitsysLogin="'+coCircuit_sysLogin+'"                                 ');
  MyWriteLN('$circuitenterpriseGuid="'+coCircuit_enterpriseGuid+'"                     ');
  MyWriteLN('$circuitbusinessEntityGuid ="'+coCircuit_businessEntityGuid+'"            ');
  MyWriteLN('                                                                           ');
  MyWriteLN('$circuitCountTry           = '+coCircuit_CountTry+'                        ');
  MyWriteLN('$circuitPause              = '+coCircuit_Pause+'                           ');
  MyWriteLN('$ReportPath = "'+_ExcelFileOut +'"                                         ');
  MyWriteLN('[String]$GlobError                                                                   ');
  MyWriteLN('$GlobError = ""                                                                      ');
  MyWriteLN('$RQST_GUID = "'+_OleGenerateGUID+'"                                                                                     ');
  MyWriteLN('$conStrinGal  = '''+GetConnString+'''');

  MyWriteLN('                                                                             ');
  MyWriteLN('$StockUUID             =    '''+ _VetisDiscrepancy.StockUUID             +''' ');
  MyWriteLN('$productType           =    '''+ _VetisDiscrepancy.productType           +''' ');
  MyWriteLN('$ProductGuid           =    '''+ _VetisDiscrepancy.ProductGuid           +''' ');
  MyWriteLN('$subProductGuid        =    '''+ _VetisDiscrepancy.subProductGuid        +''' ');
  MyWriteLN('$productItemGlobalGUID =    '''+ _VetisDiscrepancy.productItemGlobalGUID +''' ');
  MyWriteLN('$productItemNAME       =    '''+ _VetisDiscrepancy.productItemNAME       +''' ');
  MyWriteLN('$volume                =    '''+ _VetisDiscrepancy.volume                +''' ');
  MyWriteLN('$UnitGuid              =    '''+ _VetisDiscrepancy.UnitGuid              +''' ');
  MyWriteLN('$FirstDateYear         =    '''+ _VetisDiscrepancy.FirstDateYear         +''' ');
  MyWriteLN('$FirstDateMonth        =    '''+ _VetisDiscrepancy.FirstDateMonth        +''' ');
  MyWriteLN('$FirstDateDay          =    '''+ _VetisDiscrepancy.FirstDateDay          +''' ');
  MyWriteLN('$ExpiryDateYear        =    '''+ _VetisDiscrepancy.ExpiryDateYear        +''' ');
  MyWriteLN('$ExpiryDateMonth       =    '''+ _VetisDiscrepancy.ExpiryDateMonth       +''' ');
  MyWriteLN('$ExpiryDateDay         =    '''+ _VetisDiscrepancy.ExpiryDateDay         +''' ');
  MyWriteLN('$batchID               =    '''+ _VetisDiscrepancy.batchID               +''' ');
  MyWriteLN('$perishable            =    '''+ _VetisDiscrepancy.perishable            +''' ');
  MyWriteLN('$countryGUID           =    '''+ _VetisDiscrepancy.countryGUID           +''' ');
  MyWriteLN('$producerGUID          =    '''+ _VetisDiscrepancy.producerGUID          +''' ');
  MyWriteLN('$producerROLE          =    '''+ _VetisDiscrepancy.producerROLE          +''' ');
  MyWriteLN('$LowGradeCargo         =    '''+ _VetisDiscrepancy.LowGradeCargo         +''' ');
  MyWriteLN('$packageLevel4         =    '''+ _VetisDiscrepancy.packageLevel4         +''' ');
  MyWriteLN('$packingTypeGUID4      =    '''+ _VetisDiscrepancy.packingTypeGUID4      +''' ');
  MyWriteLN('$Quantity4             =    '''+ _VetisDiscrepancy.Quantity4             +''' ');
  MyWriteLN('$EAN4128               =    '''+ _VetisDiscrepancy.EAN4128               +''' ');
  MyWriteLN('$EAN413                =    '''+ _VetisDiscrepancy.EAN413                +''' ');
  MyWriteLN('$packageLevel2         =    '''+ _VetisDiscrepancy.packageLevel2         +''' ');
  MyWriteLN('$packingTypeGUID2      =    '''+ _VetisDiscrepancy.packingTypeGUID2      +''' ');
  MyWriteLN('$Quantity2             =    '''+ _VetisDiscrepancy.Quantity2             +''' ');
  MyWriteLN('$EAN213                =    '''+ _VetisDiscrepancy.EAN213                +''' ');
  MyWriteLN('$ReasonName            =    '''+ _VetisDiscrepancy.ReasonName            +''' ');
  MyWriteLN('                                                                              ');
  MyWriteLN('                                                                              ');
  MyWriteLN('$ReportPath = "C:\Galaktika\_Vetis_PS\RQST\"                                  ');
  MyWriteLN('                                                                              ');
  MyWriteLN('[String]$GlobError                                                            ');
  MyWriteLN('$GlobError = ''''                                                               ');
  MyWriteLN('                                                                              ');
  MyWriteLN('function Invoke-DatabaseQuery {                                                         ');
  MyWriteLN('        [CmdletBinding()]                                                               ');
  MyWriteLN('        param (                                                                         ');
  MyWriteLN('                [string]$connectionString,                                              ');
  MyWriteLN('                [string]$query,                                                         ');
  MyWriteLN('                [switch]$isSQLServer                                                    ');
  MyWriteLN('        )                                                                               ');
  MyWriteLN('        if ($isSQLServer) {                                                             ');
  MyWriteLN('                Write-Verbose ''in SQL Server mode''                                    ');
  MyWriteLN('                $connection = New-Object -TypeName System.Data.SqlClient.SqlConnection  ');
  MyWriteLN('        } else {                                                                        ');
  MyWriteLN('                Write-Verbose ''in OleDB mode''                                         ');
  MyWriteLN('                $connection = New-Object -TypeName System.Data.OleDb.OleDbConnection    ');
  MyWriteLN('        }                                                                               ');
  MyWriteLN('        $connection.ConnectionString = $connectionString                                ');
  MyWriteLN('        $command = $connection.CreateCommand()                                          ');
  MyWriteLN('        $command.CommandText = $query                                                   ');
  MyWriteLN('        $connection.Open()                                                              ');
  MyWriteLN('        $command.ExecuteNonQuery()                                                      ');
  MyWriteLN('        $connection.close()                                                             ');
  MyWriteLN('}                                                                                       ');

  MyWriteLN('function ToUTF8([string]$strSRC)                                              ');
  MyWriteLN('{                                                                             ');
  MyWriteLN(' $defaultEncoding = [System.Text.Encoding]::GetEncoding(''ISO-8859-1'')       ');
  MyWriteLN(' $value = $strSRC                                                             ');
  MyWriteLN(' $utf8Bytes = [System.Text.Encoding]::UTf8.GetBytes($value)                   ');
  MyWriteLN(' $defaultEncoding.GetString($utf8bytes)                                       ');
  MyWriteLN('}                                                                             ');
  MyWriteLN('                                                                              ');
  MyWriteLN('Function GetDataFromWeb([xml]$fnXML, [string]$URL)                            ');
  MyWriteLN('{                                                                             ');
  MyWriteLN('                                                                              ');
  MyWriteLN('#write-host $URL                                                              ');
  MyWriteLN('                                                                              ');
  MyWriteLN('#write-host $fnXML.FirstChild.dt                                              ');
  MyWriteLN('                                                                              ');
  MyWriteLN('$headers = @{}                                                                ');
  MyWriteLN('$headers.add("SOAPAction","GetResponse")                                      ');
  MyWriteLN('$headers.add("Accept","text/xml")                                             ');
  MyWriteLN('                                                                              ');
  MyWriteLN('                                                                              ');
  MyWriteLN('                                                                              ');
  MyWriteLN('$credentials = New-Object System.Management.Automation.PSCredential -ArgumentList @($circuitlogin,(ConvertTo-SecureString -String $circuitpassword -AsPlainText -Force)) ');
  MyWriteLN('   try                                                                                                                                                                   ');
  MyWriteLN('    {                                                                                                                                                                    ');
  MyWriteLN('     Invoke-WebRequest -URI $URL -Headers $headers -Method Post -Body $fnXML -ContentType ''text/xml;charset="utf-8"'' -Credential $credentials -UseBasicParsing         ');
  MyWriteLN('    }                                                                                                                                                                    ');
  MyWriteLN('    catch                                                                                                                                                                ');
  MyWriteLN('    {                                                                                                                                                                    ');
  MyWriteLN('      $GlobError = $error[0]                                                                                                                                             ');
  MyWriteLN('      $null                                                                                                                                                              ');
  MyWriteLN('    }                                                                                                                                                                    ');
  MyWriteLN('}                                                                                                                                                                        ');
  MyWriteLN('Function GetResponse()                                                                                                                                                   ');
  MyWriteLN('{                                                                                                                                                                        ');
  MyWriteLN(' $str1 = ''xmlns:dt="http://api.vetrf.ru/schema/cdm/dictionary/v2" xmlns:bs="http://api.vetrf.ru/schema/cdm/base" xmlns:merc="http://api.vetrf.ru/schema/cdm/mercury/g2b/applications/v2"'' ');
  MyWriteLN(' $str1 = $str1 +'' xmlns:apldef="http://api.vetrf.ru/schema/cdm/application/ws-definitions" xmlns:apl="http://api.vetrf.ru/schema/cdm/application" xmlns:vd="http://api.vetrf.ru/schema/cdm/mercury/vet-document/v2" '' ');
  MyWriteLN(' $str1 = $str1 +'' xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/"> '' ');
  MyWriteLN(' $template = @''           ');
  MyWriteLN('<SOAP-ENV:Envelope {35} ');
  MyWriteLN('<SOAP-ENV:Header/>                                                        ');
  MyWriteLN('<SOAP-ENV:Body>                                                           ');
  MyWriteLN('<apldef:submitApplicationRequest>                                         ');
  MyWriteLN('<apldef:apiKey>{0}</apldef:apiKey>                                        ');
  MyWriteLN('<apl:application>                                                         ');
  MyWriteLN('<apl:serviceId>{1}</apl:serviceId>                                        ');
  MyWriteLN('<apl:issuerId>{2}</apl:issuerId>                                          ');
  MyWriteLN('<apl:issueDate>'+datetostr(cur_date,'YYYY-MM-DD')+'T'+timetostr(cur_time,'HH:MM:SS')+'+03:00</apl:issueDate>                  ');
  MyWriteLN('<apl:data>                                                                ');
  MyWriteLN('<merc:resolveDiscrepancyRequest>                                          ');
  MyWriteLN('<merc:localTransactionId>'+'ATLANTIC'+datetostr(cur_date,'YYMMDD')+timetostr(cur_time,'HHMMSS')+'</merc:localTransactionId>  ');
  MyWriteLN('<merc:initiator>                                                          ');
  MyWriteLN('<vd:login>{3}</vd:login>                                                  ');
  MyWriteLN('</merc:initiator>                                                         ');
  MyWriteLN('<merc:enterprise>                                                         ');
  MyWriteLN('<bs:guid>{4}</bs:guid>                                                    ');
  MyWriteLN('</merc:enterprise>                                                        ');
  MyWriteLN('<merc:inventoryDate>'+datetostr(cur_date,'YYYY-MM-DD')+'T'+timetostr(cur_time,'HH:MM:SS')+'+03:00</merc:inventoryDate>        ');
  MyWriteLN('<merc:responsible>                                                        ');
  MyWriteLN('<vd:login>{3}</vd:login>                                                  ');
  MyWriteLN('</merc:responsible>                                                       ');
  MyWriteLN('<merc:stockDiscrepancy id="inventory">                                    ');
  MyWriteLN('<vd:resultingList>                                                        ');
  MyWriteLN('<vd:stockEntry>                                                           ');
  MyWriteLN('<bs:uuid>{5}</bs:uuid>                                                    ');
  MyWriteLN('<vd:batch>                                                                ');
  MyWriteLN('<vd:productType>{6}</vd:productType>                                      ');
  MyWriteLN('<vd:product>                                                              ');
  MyWriteLN('<bs:guid>{7}</bs:guid>                                                    ');
  MyWriteLN('</vd:product>                                                             ');
  MyWriteLN('<vd:subProduct>                                                           ');
  MyWriteLN('<bs:guid>{8}</bs:guid>                                                    ');
  MyWriteLN('</vd:subProduct>                                                          ');
  MyWriteLN('<vd:productItem>                                                          ');
  MyWriteLN('<dt:globalID>{9}</dt:globalID>                                            ');
  MyWriteLN('<dt:name>{10}</dt:name>                                                   ');
// НИже вставыш - константой на 0.095
  MyWriteLN('<dt:packaging>                                                            ');
  MyWriteLN('<dt:packagingType>                                                        ');
  MyWriteLN('<bs:guid>fedf4328-053c-11e1-99b4-d8d385fbc9e8</bs:guid>                   ');
  MyWriteLN('<dt:globalID>CT</dt:globalID>                                             ');
  MyWriteLN('</dt:packagingType>                                                       ');
  MyWriteLN('<dt:quantity>12</dt:quantity>                                             ');
  MyWriteLN('<dt:volume>0.095</dt:volume>                                              ');
  MyWriteLN('<dt:unit>                                                                 ');
  MyWriteLN('<bs:guid>21ed96c9-337b-4a27-8761-c6e6ad3c9f5b</bs:guid>                   ');
  MyWriteLN('</dt:unit>                                                                ');
  MyWriteLN('</dt:packaging>                                                           ');
//end  НИже вставыш - константой на 0.095

  MyWriteLN('</vd:productItem>                                                         ');
  MyWriteLN('<vd:volume>{11}</vd:volume>                                               ');
  MyWriteLN('<vd:unit>                                                                 ');
  MyWriteLN('<bs:guid>{12}</bs:guid>                                                   ');
  MyWriteLN('</vd:unit>                                                                ');
  MyWriteLN('<vd:dateOfProduction>                                                     ');
  MyWriteLN('<vd:firstDate>                                                            ');
  MyWriteLN('<dt:year>{13}</dt:year>                                                   ');
  MyWriteLN('<dt:month>{14}</dt:month>                                                 ');
  MyWriteLN('<dt:day>{15}</dt:day>                                                     ');
  MyWriteLN('</vd:firstDate>                                                           ');
  MyWriteLN('</vd:dateOfProduction>                                                    ');
  MyWriteLN('<vd:expiryDate>                                                           ');
  MyWriteLN('<vd:firstDate>                                                            ');
  MyWriteLN('<dt:year>{16}</dt:year>                                                   ');
  MyWriteLN('<dt:month>{17}</dt:month>                                                 ');
  MyWriteLN('<dt:day>{18}</dt:day>                                                     ');
  MyWriteLN('</vd:firstDate>                                                           ');
  MyWriteLN('</vd:expiryDate>                                                          ');
  MyWriteLN('<vd:batchID>{19}</vd:batchID>                                             ');
  MyWriteLN('<vd:perishable>{20}</vd:perishable>                                       ');
  MyWriteLN('<vd:origin>                                                               ');
  MyWriteLN('<vd:productItem>                                                          ');
  MyWriteLN('<dt:globalID>{9}</dt:globalID>                                            ');
  MyWriteLN('<dt:name>{10}</dt:name>                                                   ');
  MyWriteLN('</vd:productItem>                                                         ');
  MyWriteLN('<vd:country>                                                              ');
  MyWriteLN('<bs:guid>{21}</bs:guid>                                                   ');
  MyWriteLN('</vd:country>                                                             ');
  MyWriteLN('<vd:producer>                                                             ');
  MyWriteLN('<dt:enterprise>                                                           ');
  MyWriteLN('<bs:guid>{22}</bs:guid>                                                   ');
  MyWriteLN('</dt:enterprise>                                                          ');
  MyWriteLN('<dt:role>{23}</dt:role>                                                   ');
  MyWriteLN('</vd:producer>                                                            ');
  MyWriteLN('</vd:origin>                                                              ');
  MyWriteLN('<vd:lowGradeCargo>{24}</vd:lowGradeCargo>                                 ');
  MyWriteLN('<vd:packageList>                                                          ');
  MyWriteLN('<dt:package>                                                              ');
  MyWriteLN('<dt:level>{25}</dt:level>                                                 ');
  MyWriteLN('<dt:packingType>                                                          ');
  MyWriteLN('<bs:guid>{26}</bs:guid>                                                   ');
  MyWriteLN('</dt:packingType>                                                         ');
  MyWriteLN('<dt:quantity>{27}</dt:quantity>                                           ');
  MyWriteLN('<dt:productMarks class="EAN128">{28}</dt:productMarks>                    ');
  MyWriteLN('<dt:productMarks class="EAN13">{29}</dt:productMarks>                     ');
  MyWriteLN('</dt:package>                                                             ');
  MyWriteLN('<dt:package>                                                              ');
  MyWriteLN('<dt:level>{30}</dt:level>                                                 ');
  MyWriteLN('<dt:packingType>                                                          ');
  MyWriteLN('<bs:guid>{31}</bs:guid>                                                   ');
  MyWriteLN('</dt:packingType>                                                         ');
  MyWriteLN('<dt:quantity>{32}</dt:quantity>                                           ');
  MyWriteLN('<dt:productMarks class="EAN13">{33}</dt:productMarks>                     ');
  MyWriteLN('</dt:package>                                                             ');
  MyWriteLN('</vd:packageList>                                                         ');
  MyWriteLN('</vd:batch>                                                               ');
  MyWriteLN('</vd:stockEntry>                                                          ');
  MyWriteLN(' </vd:resultingList>                                                      ');
  MyWriteLN('</merc:stockDiscrepancy>                                                  ');
  MyWriteLN('<merc:discrepancyReport for="inventory">                                  ');
  MyWriteLN('<vd:reason>                                                               ');
  MyWriteLN('<vd:name>{34}</vd:name>                                                   ');
  MyWriteLN('</vd:reason>                                                              ');
  MyWriteLN('</merc:discrepancyReport>                                                 ');
  MyWriteLN('</merc:resolveDiscrepancyRequest>                                         ');
  MyWriteLN('</apl:data>                                                               ');
  MyWriteLN('</apl:application>                                                        ');
  MyWriteLN('</apldef:submitApplicationRequest>                                        ');
  MyWriteLN('</SOAP-ENV:Body>                                                          ');
  MyWriteLN('</SOAP-ENV:Envelope>                                                      ');
  MyWriteLN('''@                                                                        ');
  MyWriteLN('                                                                          ');
  MyWriteLN('#            webRequest.Credentials = credentials;                        ');
  MyWriteLN('                                                                          ');
  MyWriteLN('$fnc_RqstBody = $template -f  $circuitapiKey, $circuitserviceID, $circuitissureId, $circuitsysLogin, $circuitenterpriseGuid` ');
  MyWriteLN('                            , $StockUUID, $productType, $ProductGuid, $subProductGuid, $productItemGlobalGUID`               ');
  MyWriteLN('                            , $productItemNAME,$volume, $UnitGuid, $FirstDateYear, $FirstDateMonth, $FirstDateDay`           ');
  MyWriteLN('                            , $ExpiryDateYear, $ExpiryDateMonth, $ExpiryDateDay,$batchID, $perishable, $countryGUID`         ');
  MyWriteLN('                            , $producerGUID, $producerROLE, $LowGradeCargo, $packageLevel4, $packingTypeGUID4,$Quantity4`    ');
  MyWriteLN('                            , $EAN4128, $EAN413, $packageLevel2, $packingTypeGUID2, $Quantity2, $EAN213, $ReasonName,$str1   ');
  MyWriteLN('                                                                                                                             ');
  MyWriteLN('                                                                                                                             ');
  MyWriteLN('#$enc = [System.Text.Encoding]::Default.GetBytes($fnc_RqstBody)                                                              ');
  MyWriteLN('#$fnc_RqstBody = [System.Text.Encoding]::utf8.GetString($enc)                                                                ');
  MyWriteLN('$fnc_RqstBody = ToUTF8 -strSRC $fnc_RqstBody                                                                                 ');
  MyWriteLN('                                                                                                                             ');
  MyWriteLN('                                                                                                                             ');
  MyWriteLN('                                                                                                                             ');
  MyWriteLN('[xml] $XmlPrepare = $fnc_RqstBody                                                                                            ');
  MyWriteLN('                                                                                                                             ');
  MyWriteLN('$response = GetDataFromWeb -fnXML $XmlPrepare -URL $circuitendpointUrl                                                       ');
  MyWriteLN('                                                                                                                             ');
  MyWriteLN('    If ( ($response.StatusCode -eq 200) -and ($response -ne $null))                                                          ');
  MyWriteLN('    {                                                                                                                        ');
  MyWriteLN('     [xml] $XmlResponse = $response.content                                                                                  ');
  MyWriteLN('     #write-host $response.content                                                                                           ');
  MyWriteLN('     $XmlResponse.GetElementsByTagName(''applicationId'').Item(0).FirstChild.data                                              ');
  MyWriteLN('    }                                                                                                                        ');
  MyWriteLN('    else                                                                                                                     ');
  MyWriteLN('    {                                                                                                                        ');
  MyWriteLN('     $null                                                                                                                   ');
  MyWriteLN('    }                                                                                                                        ');
  MyWriteLN('}                                                                                                                            ');
  MyWriteLN('Function RecieveApplRqst([string]$requestAplId)                                                                              ');
  MyWriteLN('{                                                                                                                            ');
  MyWriteLN('$template=@''                                                                                                                 ');
  MyWriteLN('<SOAP-ENV:Envelope                                                                                                           ');
  MyWriteLN('                    xmlns:dt="http://api.vetrf.ru/schema/cdm/dictionary/v2"                                                  ');
  MyWriteLN('                    xmlns:bs="http://api.vetrf.ru/schema/cdm/base"                                                           ');
  MyWriteLN('                    xmlns:merc="http://api.vetrf.ru/schema/cdm/mercury/g2b/applications/v2"                                  ');
  MyWriteLN('                    xmlns:apldef="http://api.vetrf.ru/schema/cdm/application/ws-definitions"                                 ');
  MyWriteLN('                    xmlns:apl="http://api.vetrf.ru/schema/cdm/application"                                                   ');
  MyWriteLN('                    xmlns:vd="http://api.vetrf.ru/schema/cdm/mercury/vet-document/v2"                                        ');
  MyWriteLN('                    xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/"                                               ');
  MyWriteLN('                    xmlns:ws="http://api.vetrf.ru/schema/cdm/application/ws-definitions">                                    ');
  MyWriteLN('                <SOAP-ENV:Header/>                                                                                           ');
  MyWriteLN('                <SOAP-ENV:Body>                                                                                              ');
  MyWriteLN('                    <ws:receiveApplicationResultRequest>                                                                     ');
  MyWriteLN('                        <ws:apiKey>{0}</ws:apiKey>                                                                           ');
  MyWriteLN('                        <ws:issuerId>{1}</ws:issuerId>                                                                       ');
  MyWriteLN('                        <ws:applicationId>{2}</ws:applicationId>                                                             ');
  MyWriteLN('                    </ws:receiveApplicationResultRequest>                                                                    ');
  MyWriteLN('                </SOAP-ENV:Body>                                                                                             ');
  MyWriteLN('</SOAP-ENV:Envelope>                                                                                                         ');
  MyWriteLN('''@                                                                                                                           ');
  MyWriteLN('#            webRequest.Credentials = credentials;                                                                           ');
  MyWriteLN('                                                                                                                             ');
  MyWriteLN('$fnc_RqstBody = $template -f $circuitapiKey, $circuitissureId, $requestAplId                                                 ');
  MyWriteLN('  $isContinue = $true                                                                                                        ');
  MyWriteLN('  $CountTRy = 0                                                                                                              ');
  MyWriteLN('[xml] $XmlPrepare = $fnc_RqstBody                                                                                            ');
  MyWriteLN('[xml] $result = $null                                                                                                        ');
  MyWriteLN('                                                                                                                             ');
  MyWriteLN('                                                                                                                             ');
  MyWriteLN('  while ($isContinue -eq $true)                                                                                              ');
  MyWriteLN('  {                                                                                                                          ');
  MyWriteLN('    Wait-Event -Timeout $circuitPause                                                                                        ');
  MyWriteLN('   $CountTRy = $CountTRy + 1                                                                                                 ');
  MyWriteLN('   $response = GetDataFromWeb -fnXML $XmlPrepare -URL $circuitendpointUrl                                                    ');
  MyWriteLN('   [string] $currentStatus = ''''                                                                                              ');
  MyWriteLN('    If ( ($response.StatusCode -eq 200) -and ($response -ne $null))                                                          ');
  MyWriteLN('    {                                                                                                                        ');
  MyWriteLN('     [xml] $XmlResponse = $response.content                                                                                  ');
  MyWriteLN('     $currentStatus = $XmlResponse.GetElementsByTagName(''status'').Item(0).FirstChild.data                                    ');
  MyWriteLN('     if ($currentStatus -eq ''COMPLETED'')                                                                                     ');
  MyWriteLN('      {                                                                                                                      ');
  MyWriteLN('       $isContinue = $false                                                                                                  ');
  MyWriteLN('       $result = $XmlResponse                                                                                                ');
  MyWriteLN('       # write-host $response.content                                                                                        ');
  MyWriteLN('      }                                                                                                                      ');
  MyWriteLN('    if ($currentStatus -eq ''REJECTED'')                                                                                       ');
  MyWriteLN('      {                                                                                                                      ');
  MyWriteLN('       $isContinue = $false                                                                                                  ');
  MyWriteLN('       $result = $null                                                                                                       ');
  MyWriteLN('       if ($XmlResponse.Envelope.Body.receiveApplicationResultResponse.application.errors.error.''#text'' -ne $null)           ');
  MyWriteLN('       {                                                                                                                     ');
  MyWriteLN('        write-host $XmlResponse.Envelope.Body.receiveApplicationResultResponse.application.errors.error.''#text'' -ForegroundColor Red ');
  MyWriteLN('       }                                                                                                                             ');
  MyWriteLN('       else                                                                                                                          ');
  MyWriteLN('        {                                                                                                                            ');
  MyWriteLN('         write-host ''Запрос отклонен'' -ForegroundColor Red                                                                           ');
  MyWriteLN('        }                                                                                                                            ');
  MyWriteLN('       Wait-Event -Timeout 5                                                                                                         ');
  MyWriteLN('      }                                                                                                                              ');
  MyWriteLN('    }                                                                                                                                ');
  MyWriteLN('    else                                                                                                                             ');
  MyWriteLN('    {                                                                                                                                ');
  MyWriteLN('     $null                                                                                                                           ');
  MyWriteLN('    }                                                                                                                                ');
  MyWriteLN('    #write-host "try number $CountTRy of $circuitCountTry | Curent state: $currentStatus"                                            ');
  MyWriteLN('    write-host "Запрос Discrepancy. Прослушивание ответа API. Запрос $CountTRy из $circuitCountTry. Получен ответ: $currentStatus"  -ForegroundColor Green ');
  MyWriteLN('    if ($circuitCountTry -lt $CountTRy )                                                                                                                   ');
  MyWriteLN('     {                                                                                                                                                     ');
  MyWriteLN('      $isContinue = $false                                                                                                                                 ');
  MyWriteLN('     }                                                                                                                                                     ');
  MyWriteLN('  }                                                                                                                                                        ');
  MyWriteLN(' $result                                                                                                                                                   ');
  MyWriteLN('}                                                                                                                                                          ');
  MyWriteLN('[xml]$stockEntryElementList = $null                                                                                                                        ');
  MyWriteLN(' write-host "Запрос Discrepancy. Отправка запроса Application ID"  -ForegroundColor Green                                                                  ');
  MyWriteLN('$requestAplId = GetResponse                                                                                                                                ');
  MyWriteLN('write-host "Запрос Discrepancy. Application ID = " $requestAplId  -ForegroundColor Green                                                                   ');
  MyWriteLN('                                                                                                                                                           ');
  MyWriteLN('if ($GlobError -eq '''')                                                                                                                                     ');
  MyWriteLN('{                                                                                                                                                          ');
  MyWriteLN(' write-host "Запрос Discrepancy. Прослушивание ответа API"  -ForegroundColor Green                                                                         ');
  MyWriteLN(' $stockEntryElementList = RecieveApplRqst($requestAplId)                                                                                                   ');
  MyWriteLN('                                                                                                                                                           ');
  MyWriteLN('}                                                                                                                                                          ');
  MyWriteLN('else                                                                                                                                                       ');
  MyWriteLN('{                                                                                                                                                          ');
  MyWriteLN(' $GlobError                                                                                                                                                ');
  MyWriteLN('}                                                                                                                                                          ');
  MyWriteLN('                                                                                                                                                           ');
  MyWriteLN(' $FinalReport  = $null                                                                                                                                     ');



  MyWriteLN('if ($stockEntryElementList -ne $null)                                                    ');
  MyWriteLN('{                                                                                 ');
  MyWriteLN('  $Response = $stockEntryElementList                                              ');
  MyWriteLN(' Write-host "Запрос stock by guid. Разбор XML"  -ForegroundColor Green            ');
  MyWriteLN('[System.Collections.ArrayList] $FinalReport = @();                                ');
  MyWriteLN('  foreach($stockEntry in $stockEntryElementList.Envelope.Body.receiveApplicationResultResponse.application.result.resolveDiscrepancyResponse.stockEntryList.stockEntry)');
  MyWriteLN('    {                                                                                                                                                     ');
  MyWriteLN('     $item = New-Object PSObject                                                                                                                           ');
  MyWriteLN('     $item | Add-Member -type NoteProperty -Name "'+coPS1_stock_GUID+'" -value $stockEntry.Guid              ');
  MyWriteLN('     $item | Add-Member -type NoteProperty -Name "'+co_PS1_REQUESTERROR+'" -value $GlobError.tostring()             ');
  MyWriteLN('     $FinalReport +=,$item                                                                                      ');
  MyWriteLN('    }                                                                                                               ');
  MyWriteLN('[string]$sqlQuery = "" ');
  MyWriteLN(' [int]$npp = 1                                                                       ');
  MyWriteLN(' write-host "Запрос GETSTOCK UUID by GUID. Запись запроса " -ForegroundColor Green         ');
  MyWriteLN(' foreach($item in $FinalReport)                                                      ');
  MyWriteLN('  {                                                                                  ');
  MyWriteLN('   if([math]::Truncate($npp/23) -eq $npp/23) ');
  MyWriteLN('    {                                       ');
  MyWriteLN('     write-host "Запись в буферную таблицу полученных результатов" -ForegroundColor Cyan       ');
  MyWriteLN('     $res = Invoke-DatabaseQuery -connectionString $conStrinGal -query $sqlQuery -isSQLServer ');
  MyWriteLN('     $sqlQuery = "" ');
  MyWriteLN('    }                                       ');

  MyWriteLN('   write-host "Запрос GetStock UUID by GUID. Запись запроса " $npp.tostring()  -ForegroundColor Cyan       ');
  MyWriteLN('   foreach( $property in $item.psobject.properties.name )                            ');
  MyWriteLN('    {                                                                                ');
  MyWriteLN('      if ($item.$property -eq $null)                                                 ');
  MyWriteLN('        {                                                                            ');
  MyWriteLN('         $itemproperty = ""                                                          ');
  MyWriteLN('        }                                                                            ');
  MyWriteLN('        else                                                                         ');
  MyWriteLN('         {                                                                           ');
  MyWriteLN('          $itemproperty = $item.$property                                            ');
  MyWriteLN('         }                                                                           ');
  MyWriteLN('      $sqlQuery = $sqlQuery + ''Insert t$ATL_RQSTAPIVALUES (f$RQST_GUID, f$RSQT_PROVIDER, f$NROW, f$COLUMNNAME, f$VALUE)    ');
  MyWriteLN('                   values (''''''+$RQST_GUID+'''''',''''''+$circuitserviceID+'''''',''+$npp.tostring()+'',''''''+$property.Replace("''","''''")+'''''',''''''+$itemproperty.Replace("''","''''")+'''''') ');
  MyWriteLN('                     '' ');
  MyWriteLN('                                                                                               ');
  MyWriteLN('    }                                                                                          ');
  MyWriteLN('    $npp = $npp + 1                                                                            ');
  MyWriteLN('  }                                                                                            ');
  MyWriteLN('   write-host "Запись в буферную таблицу полученных результатов" -ForegroundColor Cyan       ');
  MyWriteLN('      $res = Invoke-DatabaseQuery -connectionString $conStrinGal -query $sqlQuery -isSQLServer ');
  MyWriteLN('      $sqlQuery = "" ');

  MyWriteLN('}                                                                                                                                      ');

}
Function GetRequestToAPIVetis_ResolveDiscrepancy(_fnVetisDiscrepancy : VetisDiscrepancy; var _result : string) : boolean;
{
  delete all tDiscrepancy;
  _rqstError := '';
  set _VetisDiscrepancy := _fnVetisDiscrepancy ;
   #BodyProcedureGetRqst(ResolveDiscrepancy,'')

  if recordsInTable(tntDiscrepancy) <> 2
  {
    Result := false;
   if getfirst tDiscrepancy <> tsOK
    {
      _result := 'Ошибка. Запрос не выполнен'
    }
    else
    {
      _result := 'Ошибка.' + tDiscrepancy.Error
    }
  }
  else
  { Result := true;
  }

}
